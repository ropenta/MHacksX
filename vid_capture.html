<!doctype html>
<html>
<head>

  <title>attempt at video capture</title>
  <meta charset="utf-8">

</head>
<body>

    <div class="camera">
        <video id="video">Video stream not available.</video>
    </div>

    <canvas id="canvas">
    </canvas>
    <div class="output">
        <img id="photo" alt="The screen capture will appear in this box.">
    </div>

    <a id="dl-btn" href="#" download="selfie.png">Save Photo</a>

    <video id="player" controls autoplay></video>
    <script>
        (function() {
            var width = 320;
            var height = 0;

            var streaming = false;

            var video = null;
            var canvas = null;
            var photo = null;

            function startup() {
                // video = document.getElementById('video');
                // canvas = document.getElementById('canvas');
                // photo = document.getElementById('photo');
                const player = document.getElementById('player');
                const constraints = {
                    video: true,
                };
                navigator.mediaDevices.getUserMedia(constraints)
                    .then((stream) => {
                    player.srcObject = stream;
                    player.play();
                    },
                    function(err){
                        console.error(err);
                    });

                // video.addEventListener('canplay', function(ev){
                //     if (!streaming) {
                //         height = video.videoHeight / (video.videoWidth/width);
                    
                //         video.setAttribute('width', width);
                //         video.setAttribute('height', height);
                //         canvas.setAttribute('width', width);
                //         canvas.setAttribute('height', height);
                //         streaming = true;
                //     }
                // }, false);
                setInterval(takeSnapshot, 5000);
                clearphoto();
            }

            function clearphoto() {
                var context = canvas.getContext('2d');
                context.fillStyle = "#AAA";
                context.fillRect(0, 0, canvas.width, canvas.height);

                var data = canvas.toDataURL('image/png');
                photo.setAttribute('src', data);
            }

            function takeSnapshot(){
                alert("starting");
                var hidden_canvas = document.querySelector('canvas'),
                    video = document.querySelector('video.camera_stream'),
                    image = document.querySelector('img.photo'),

                    // Get the exact size of the video element.
                    width = video.videoWidth,
                    height = video.videoHeight,

                    // Context object for working with the canvas.
                    context = hidden_canvas.getContext('2d');

                // Set the canvas to the same dimensions as the video.
                hidden_canvas.width = width;
                hidden_canvas.height = height;

                // Draw a copy of the current frame from the video on the canvas.
                context.drawImage(video, 0, 0, width, height);

                // Get an image dataURL from the canvas.
                var imageDataURL = hidden_canvas.toDataURL('image/png');

                // Set the dataURL as source of an image element, showing the captured photo.
                image.setAttribute('src', imageDataURL); 
                alert("ending");
                clearphoto();

            }


            // function takepicture() {
            //     var context = canvas.getContext('2d');
            //     if (width && height) {
            //     canvas.width = width;
            //     canvas.height = height;
            //     context.drawImage(video, 0, 0, width, height);
                
            //     var data = canvas.toDataURL('image/png');
            //     photo.setAttribute('src', data);
            //     } else {
            //     clearphoto();
            //     }
            // }

            window.addEventListener('load', startup, false);
        })();
    </script>




    <video id="player" controls autoplay></video>
    <script>

    </script>

</body>
</html>
